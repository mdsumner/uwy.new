name: Update Underway (Simple)

# Simplest approach: full fetch each time, atomic replace
# Best for moderate-sized datasets where incremental complexity isn't worth it

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  GDAL_IMAGE: ghcr.io/osgeo/gdal:ubuntu-full-3.12.1
  RELEASE_TAG: v0.0.1
  PARQUET_FILE: nuyina_underway.parquet

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch full dataset from WFS
        id: fetch
        run: |
          mkdir -p data

          # Fetch to temp file first
          docker run --rm -v "$PWD/data:/data" ${{ env.GDAL_IMAGE }} \
            ogr2ogr -f Parquet "/data/temp.parquet" \
            "WFS:https://data.aad.gov.au/geoserver/ows?service=wfs&version=2.0.0&request=GetCapabilities" \
            "underway:nuyina_underway" \
            -lco COMPRESSION=ZSTD \
            -progress

          # Validate: file exists and has records
          if [[ -f "data/temp.parquet" ]] && [[ -s "data/temp.parquet" ]]; then
            COUNT=$(docker run --rm -v "$PWD/data:/data" ${{ env.GDAL_IMAGE }} \
              ogrinfo -sql "SELECT COUNT(*) as cnt FROM temp" "/data/temp.parquet" 2>/dev/null | \
              grep -oE 'cnt \(Integer\) = [0-9]+' | grep -oE '[0-9]+' || echo "0")

            if [[ "$COUNT" -gt 0 ]]; then
              # Atomic rename
              mv "data/temp.parquet" "data/${{ env.PARQUET_FILE }}"
              echo "success=true" >> $GITHUB_OUTPUT
              echo "count=$COUNT" >> $GITHUB_OUTPUT
              echo "Fetched $COUNT records successfully"
            else
              echo "ERROR: Fetch produced file with 0 records"
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "ERROR: Fetch produced no file"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Show stats
        if: steps.fetch.outputs.success == 'true'
        run: |
          echo "Records: ${{ steps.fetch.outputs.count }}"
          echo "Size: $(stat -c%s "data/${{ env.PARQUET_FILE }}") bytes"

          # Show datetime range
          docker run --rm -v "$PWD/data:/data" ${{ env.GDAL_IMAGE }} \
            ogrinfo -sql "SELECT MIN(datetime), MAX(datetime) FROM nuyina_underway" \
            "/data/${{ env.PARQUET_FILE }}" 2>/dev/null | grep -E 'MIN|MAX' || true

      - name: Upload to release
        if: steps.fetch.outputs.success == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: data/${{ env.PARQUET_FILE }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
