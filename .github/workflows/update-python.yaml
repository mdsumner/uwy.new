name: Update Underway Data (Python)

on:
  #schedule:
  #  - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  RELEASE_TAG: v0.0.1
  PARQUET_FILE: nuyina_underway.parquet

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install duckdb

      - name: Run update script
        id: update
        run: |
          python scripts/update_underway.py

          if [[ -f "${{ env.PARQUET_FILE }}" ]]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "size=$(stat -c%s ${{ env.PARQUET_FILE }})" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload to release
        if: steps.update.outputs.success == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: ${{ env.PARQUET_FILE }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
